<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entra√Æneur d'Intervalles - Guitare Impro Acad√©mie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        
        .bg-gia-gradient {
            background: radial-gradient(circle at center, #1f2937 0%, #111827 100%);
            position: relative;
            overflow: hidden;
        }
        .bg-gia-gradient::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23374151' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
            z-index: 0;
        }

        /* Fretboard styling */
        .fretboard { background: linear-gradient(90deg, #5D4037, #3E2723); border: 4px solid #281810; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        .fret-line { background-color: #B0BEC5; box-shadow: 1px 0 2px rgba(0,0,0,0.5); }
        .fret-nut { background-color: #E0E0E0; box-shadow: 2px 0 5px rgba(0,0,0,0.5); }
        .string { background-color: #E0E0E0; box-shadow: 0 2px 4px rgba(0,0,0,0.4); transition: opacity 0.3s ease; }
        
        /* Note styling */
        .note-target:hover::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 32px; height: 32px;
            background-color: rgba(255, 255, 255, 0.2); border-radius: 50%; opacity: 1;
        }
        .note-dot { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 3px 6px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.8); }
        
        /* Utilities */
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .btn-highlight { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0); transform: scale(1.02); } }
        
        .answer-btn { border-bottom: 4px solid rgba(0,0,0,0.3); }
        .answer-btn:active { border-bottom: 0px solid; transform: translateY(4px); }
        .answer-btn.correct { background-color: #10B981 !important; border-color: #059669 !important; color: white; }
        .answer-btn.incorrect { background-color: #EF4444 !important; border-color: #B91C1C !important; color: white; }

        .modal-enter { animation: modal-fade-in 0.3s ease-out forwards; }
        .modal-content-enter { animation: modal-zoom-in 0.3s ease-out forwards; }
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-zoom-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .lesson-scroll::-webkit-scrollbar { width: 6px; }
        .lesson-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .lesson-scroll::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 3px; }
        
        .user-card:hover { transform: translateY(-2px); border-color: #38bdf8; }
    </style>
</head>
<body class="bg-gia-gradient text-white flex flex-col items-center justify-center min-h-screen p-4 select-none">

    <!-- --- LOGIN SCREEN --- -->
    <div id="login-screen" class="w-full max-w-md mx-auto text-center relative z-10">
        <div class="mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-400 mb-2 tracking-tight filter drop-shadow-lg">GIA TRAINER</h1>
            <p class="text-gray-400 font-medium uppercase tracking-widest text-xs">Espace Membre</p>
        </div>

        <!-- User List Container -->
        <div id="user-selection-container" class="hidden mb-6">
            <p class="text-gray-300 text-sm mb-3 font-semibold">S√©lectionnez votre profil :</p>
            <div id="users-list" class="grid grid-cols-2 gap-3 max-h-48 overflow-y-auto lesson-scroll p-1">
                <!-- Users will be injected here -->
            </div>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink-0 mx-4 text-gray-500 text-xs uppercase">Ou nouveau membre</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>
        </div>
        
        <div class="bg-gray-800/80 p-8 rounded-2xl border border-gray-700 shadow-2xl backdrop-blur-sm">
            <label class="block text-left text-gray-300 text-sm font-bold mb-2" for="username">Nouveau Pr√©nom</label>
            <input id="username-input" type="text" placeholder="Ex: Fran√ßois" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-600 text-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500 outline-none mb-6 transition-all" />
            <button id="login-btn" class="w-full bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-500 hover:to-indigo-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                Cr√©er & Commencer
            </button>
        </div>
    </div>

    <!-- --- MAIN MENU --- -->
    <div id="main-menu" class="hidden w-full max-w-4xl mx-auto relative z-10 flex flex-col md:flex-row gap-8 items-start">
        
        <!-- Left Column: Actions -->
        <div class="w-full md:w-1/3 text-center md:text-left">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-white">Bonjour <span id="display-username" class="text-sky-400"></span> !</h2>
                <p class="text-gray-400 text-sm mt-1">Pr√™t √† muscler ton oreille ?</p>
            </div>
            
            <div class="space-y-4">
                <button id="btn-brain-info" class="w-full bg-indigo-900/60 hover:bg-indigo-800 border border-indigo-500/30 text-indigo-200 font-semibold py-3 px-4 rounded-xl transition-all text-sm flex items-center justify-center gap-2">
                    <span>üß†</span> Le secret de l'apprentissage
                </button>
                <div class="h-px bg-gray-700 w-full my-4"></div>
                <button data-action="open-challenge-menu" class="w-full bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-lg border-b-4 border-blue-800 active:translate-y-0 active:border-b-0 transition-all">
                    üèÜ Mode Challenge
                </button>
                <button id="start-review-setup-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-100 font-bold py-4 px-6 rounded-xl shadow-lg text-lg border-b-4 border-gray-900 active:translate-y-0 active:border-b-0 transition-all">
                    üìö Mode R√©vision
                </button>
                <button id="logout-btn" class="text-xs text-gray-500 hover:text-white mt-4 underline">Changer d'utilisateur</button>
            </div>
        </div>

        <!-- Right Column: Stats Chart -->
        <div class="w-full md:w-2/3 bg-gray-800/60 p-6 rounded-2xl border border-gray-700 shadow-xl backdrop-blur-sm">
            <h3 class="text-xl font-bold text-white mb-4 flex justify-between items-center">
                Ta Progression
                <span class="text-xs font-normal text-gray-400 bg-gray-800 px-2 py-1 rounded border border-gray-600">Objectif: 30/30</span>
            </h3>
            <div class="relative w-full h-64">
                <canvas id="progressionChart"></canvas>
            </div>
            <p id="chart-loading" class="text-center text-gray-400 text-sm mt-2">Chargement des donn√©es...</p>
        </div>
    </div>

    <!-- --- CHALLENGE MENU --- -->
    <div id="challenge-selection-menu" class="hidden w-full max-w-md mx-auto text-center z-10">
        <h2 class="text-3xl font-bold text-white mb-8 filter drop-shadow-md">Choisissez votre niveau</h2>
        <div class="space-y-4">
            <button data-challenge="bronze" class="challenge-btn w-full bg-gradient-to-r from-amber-700 to-yellow-700 hover:from-amber-600 hover:to-yellow-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg border-b-4 border-yellow-900 active:border-b-0 active:translate-y-1 transition-all">
                <div class="flex items-center justify-between">
                    <span class="text-2xl">ü•â</span>
                    <div class="text-left flex-1 ml-4">
                        <div class="text-lg">Bronze</div>
                        <div class="text-xs font-normal opacity-90">10 r√©ponses ‚Ä¢ 180s ‚Ä¢ 3 Vies</div>
                    </div>
                </div>
            </button>
            <button data-challenge="silver" class="challenge-btn w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-300 hover:to-gray-400 text-gray-900 font-bold py-4 px-6 rounded-xl shadow-lg border-b-4 border-gray-700 active:border-b-0 active:translate-y-1 transition-all">
                <div class="flex items-center justify-between">
                    <span class="text-2xl">ü•à</span>
                    <div class="text-left flex-1 ml-4">
                        <div class="text-lg">Argent</div>
                        <div class="text-xs font-normal opacity-90 text-gray-800">20 r√©ponses ‚Ä¢ 180s ‚Ä¢ 3 Vies</div>
                    </div>
                </div>
            </button>
            <button data-challenge="gold" class="challenge-btn w-full bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-300 hover:to-yellow-400 text-yellow-900 font-bold py-4 px-6 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition-all">
                <div class="flex items-center justify-between">
                    <span class="text-2xl">ü•á</span>
                    <div class="text-left flex-1 ml-4">
                        <div class="text-lg">Or</div>
                        <div class="text-xs font-normal opacity-90 text-yellow-900">30 r√©ponses ‚Ä¢ 120s ‚Ä¢ 3 Vies</div>
                    </div>
                </div>
            </button>
        </div>
        <button data-action="back-to-main" class="mt-10 text-sky-400 hover:text-sky-300 font-semibold py-2 px-4 rounded hover:bg-white/5 transition-colors">‚Üê Retour au menu</button>
    </div>

    <!-- --- REVIEW SETUP SCREEN --- -->
    <div id="review-setup-screen" class="hidden w-full max-w-2xl mx-auto bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700 z-10">
        <h2 class="text-2xl font-bold text-white mb-2 text-center">Configuration de la R√©vision</h2>
        <p class="text-gray-400 text-center mb-6 text-sm">Cochez les intervalles √† travailler.</p>
        <div id="review-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-8"></div>
        <div class="flex gap-3 mb-8">
            <button id="review-select-all" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 text-xs font-bold uppercase tracking-wider py-3 rounded-lg transition-colors">Tout</button>
            <button id="review-deselect-all" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 text-xs font-bold uppercase tracking-wider py-3 rounded-lg transition-colors">Rien</button>
        </div>
        <button id="launch-review-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
            Commencer l'Entra√Ænement
        </button>
        <div class="text-center mt-6">
            <button data-action="back-to-main" class="text-gray-400 hover:text-white text-sm">Annuler</button>
        </div>
    </div>

    <!-- --- MAIN APP CONTAINER --- -->
    <div id="app-container" class="hidden w-full max-w-5xl mx-auto bg-gray-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-4 md:p-8 border border-gray-800 z-10">
        <header class="flex justify-between items-center mb-6">
             <button id="back-button" class="text-gray-400 hover:text-white text-sm font-semibold bg-gray-800 hover:bg-gray-700 py-2 px-4 rounded-lg transition-colors">‚Üê Quitter</button>
            <h1 id="app-title" class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-400"></h1>
            <div class="w-20"></div>
        </header>
        <div id="game-ui-bar" class="hidden grid grid-cols-3 gap-4 mb-6 bg-black/30 p-3 rounded-xl border border-gray-800">
            <div class="text-center"><div class="text-xs text-gray-500 uppercase">Score</div><div id="score-display" class="font-mono text-xl text-yellow-400 font-bold">0/0</div></div>
            <div class="text-center"><div class="text-xs text-gray-500 uppercase">Temps</div><div id="timer-display" class="font-mono text-xl text-sky-400 font-bold">--</div></div>
            <div class="text-center"><div class="text-xs text-gray-500 uppercase">Vies</div><div id="lives-display" class="flex justify-center gap-1 text-lg">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
        </div>
        <div id="review-lesson-box" class="hidden bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-3">
                <div class="text-2xl">üí°</div>
                <div class="flex-1">
                    <h3 class="text-indigo-300 font-bold text-sm mb-2 uppercase tracking-wide">Rappel de la s√©ance :</h3>
                    <div id="lesson-content" class="text-sm text-gray-300 space-y-1 max-h-24 overflow-y-auto lesson-scroll pr-2"></div>
                </div>
            </div>
        </div>
        <div class="bg-black/40 p-4 rounded-xl shadow-inner mb-6 overflow-x-auto">
            <div id="guitar-neck" class="relative min-w-[800px]"></div>
        </div>
        <div id="training-section-controls" class="hidden">
             <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                 <div class="flex items-center gap-3">
                     <button id="replay-sound-btn" class="bg-sky-700 hover:bg-sky-600 text-white p-3 rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95" title="R√©√©couter l'intervalle">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                     </button>
                     <div>
                         <p id="question-title" class="text-lg md:text-xl font-bold text-white">Quel est cet intervalle ?</p>
                         <p id="feedback-message" class="text-sm h-5 font-semibold"></p>
                     </div>
                 </div>
                 <button id="new-question-btn" class="w-full md:w-auto bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all border-b-4 border-sky-800 active:border-b-0 active:translate-y-1 btn-disabled">Suivant ‚Üí</button>
             </div>
             <div id="answer-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
        </div>
    </div>

    <!-- --- MODALS --- -->
    <div id="brain-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 modal-enter">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-lg modal-content-enter border border-gray-700">
            <div class="flex items-center gap-3 mb-6"><span class="text-4xl">üß†</span><h2 class="text-2xl font-bold text-white">Boostez votre apprentissage</h2></div>
            <div class="space-y-5 text-gray-300 text-base">
                <div class="bg-gray-700/50 p-4 rounded-xl border-l-4 border-sky-500"><h3 class="font-bold text-sky-400 mb-1">La My√©line</h3><p class="text-sm">R√©p√©ter juste = "autoroute neuronale". Votre cerveau isole les circuits utilis√©s pour aller plus vite.</p></div>
                <div class="bg-gray-700/50 p-4 rounded-xl border-l-4 border-green-500"><h3 class="font-bold text-green-400 mb-1">R√©p√©tition Espac√©e</h3><p class="text-sm">Mieux vaut <strong class="text-white">30 min plusieurs fois</strong> qu'une seule session de 3h. Le sommeil consolide tout.</p></div>
                <div class="bg-gray-700/50 p-4 rounded-xl border-l-4 border-pink-500"><h3 class="font-bold text-pink-400 mb-1">L'Erreur est utile</h3><p class="text-sm">Se tromper permet au cerveau de calibrer. N'ayez pas peur de l'√©chec, il fait partie du processus.</p></div>
            </div>
            <button id="close-brain-btn" class="w-full bg-white text-gray-900 hover:bg-gray-200 font-bold py-3 px-6 rounded-xl mt-8 transition-colors">C'est not√© !</button>
        </div>
    </div>

    <div id="end-game-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 modal-enter">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md text-center modal-content-enter border border-gray-700">
            <h2 id="end-game-title" class="text-3xl font-bold mb-2"></h2>
            <div id="end-game-message" class="text-gray-300 mb-8 text-lg"></div>
            <div id="end-game-buttons" class="flex flex-col gap-3"></div>
        </div>
    </div>

    <footer class="mt-8 text-center text-gray-500 text-xs font-medium tracking-wider relative z-10">¬© GUITARE IMPRO ACAD√âMIE</footer>

    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // App Logic
        let currentUserPseudo = localStorage.getItem('gia_username') || '';
        let existingUsers = [];
        let progressChart = null;

        // Auth Init
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                console.log("Connected to Firebase (Anonymous)");
                // Listen for users immediately to populate the list
                listenForUsers();
                if(currentUserPseudo) {
                    // If local storage has user, auto login logic could go here, 
                    // but we might want to confirm the user exists in the list first
                    // For now, let's verify validity or just show menu
                    showMainMenu();
                }
            } catch (error) {
                console.error("Auth failed", error);
            }
        };
        
        // UI Helpers
        const el = (id) => document.getElementById(id);
        const show = (id) => document.getElementById(id).classList.remove('hidden');
        const hide = (id) => document.getElementById(id).classList.add('hidden');

        // --- Users Logic ---
        function listenForUsers() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            onSnapshot(q, (snapshot) => {
                existingUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.pseudo) existingUsers.push(data.pseudo);
                });
                // Remove duplicates and sort
                existingUsers = [...new Set(existingUsers)].sort();
                renderUserList();
            });
        }

        function renderUserList() {
            const container = el('users-list');
            const wrapper = el('user-selection-container');
            container.innerHTML = '';

            if (existingUsers.length > 0) {
                wrapper.classList.remove('hidden');
                existingUsers.forEach(user => {
                    const btn = document.createElement('button');
                    btn.textContent = user;
                    btn.className = 'user-card bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition-all border border-gray-600 text-left truncate';
                    btn.onclick = () => loginUser(user);
                    container.appendChild(btn);
                });
            } else {
                wrapper.classList.add('hidden');
            }
        }

        function saveUserToDB(pseudo) {
            // Check if user already exists locally to avoid spamming DB
            // Note: This is a client-side check, perfect for "bonne intelligence"
            const exists = existingUsers.some(u => u.toLowerCase() === pseudo.toLowerCase());
            if (!exists) {
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                    pseudo: pseudo,
                    createdAt: Date.now()
                });
            }
        }

        function loginUser(name) {
            currentUserPseudo = name;
            localStorage.setItem('gia_username', name);
            showMainMenu();
        }

        // --- Login Logic ---
        el('login-btn').addEventListener('click', () => {
            const name = el('username-input').value.trim();
            if(name) {
                saveUserToDB(name);
                loginUser(name);
            } else {
                alert("Merci d'entrer un pr√©nom !");
            }
        });

        el('logout-btn').addEventListener('click', () => {
            currentUserPseudo = '';
            localStorage.removeItem('gia_username');
            hide('main-menu');
            show('login-screen');
            el('username-input').value = '';
        });

        function showMainMenu() {
            el('display-username').textContent = currentUserPseudo;
            hide('login-screen');
            hide('challenge-selection-menu');
            hide('review-setup-screen');
            hide('app-container');
            show('main-menu');
            loadChartData();
        }

        // --- Chart Logic ---
        function loadChartData() {
            el('chart-loading').classList.remove('hidden');
            if (progressChart) progressChart.destroy();

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
            
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.pseudo && data.pseudo.toLowerCase() === currentUserPseudo.toLowerCase()) {
                        scores.push(data);
                    }
                });

                scores.sort((a, b) => a.timestamp - b.timestamp);
                renderChart(scores);
                el('chart-loading').classList.add('hidden');
            }, (error) => {
                console.error("Error loading scores:", error);
                el('chart-loading').textContent = "Erreur de chargement.";
            });
        }

        function renderChart(data) {
            const ctx = el('progressionChart').getContext('2d');
            
            const labels = data.map(d => new Date(d.timestamp).toLocaleDateString(undefined, {day:'numeric', month:'numeric'}));
            const dataPoints = data.map(d => d.score);
            const goalLine = Array(data.length).fill(30);

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Score',
                            data: dataPoints,
                            borderColor: '#0ea5e9', 
                            backgroundColor: 'rgba(14, 165, 233, 0.2)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4
                        },
                        {
                            label: 'Objectif',
                            data: goalLine,
                            borderColor: '#fbbf24',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#9ca3af' } } },
                    scales: {
                        y: { beginAtZero: true, max: 35, grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                        x: { grid: { color: 'transparent' }, ticks: { color: '#9ca3af', maxTicksLimit: 10 } }
                    }
                }
            });
        }

        // --- Save Score Logic ---
        window.saveScoreToFirebase = async (score, mode) => {
            if(!currentUserPseudo) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                    pseudo: currentUserPseudo,
                    score: score,
                    total: 30,
                    mode: mode,
                    timestamp: Date.now()
                });
            } catch (e) { console.error("Error saving score:", e); }
        };

        // Initialize
        initAuth();
    </script>

    <script>
        // --- GAME SCRIPT (Existing logic + Firebase Hook) ---
        document.addEventListener('DOMContentLoaded', () => {
            const NUM_STRINGS = 6, NUM_FRETS = 15;
            const SEARCH_ZONE_RADIUS = 4;
            const STRING_SEARCH_RADIUS = 2;
            const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const TUNING_SEMITONES_FROM_C0 = [40, 45, 50, 55, 59, 64];
            
            const INTERVALS_DATA = {
                '2m': { val: 1, desc: "Seconde Mineure (1/2 ton) : Dissonant, dents de la mer." },
                '2M': { val: 2, desc: "Seconde Majeure (1 ton) : Tension douce." },
                '3m': { val: 3, desc: "Tierce Mineure (1.5 tons) : Triste, m√©lancolique." },
                '3M': { val: 4, desc: "Tierce Majeure (2 tons) : Joyeux, lumineux." },
                '4J': { val: 5, desc: "Quarte Juste (2.5 tons) : Mon beau sapin." },
                '5dim': { val: 6, desc: "Quinte Diminu√©e (3 tons) : Le Triton diabolique." },
                '5J': { val: 7, desc: "Quinte Juste (3.5 tons) : Power Chord, stable." },
                '6m': { val: 8, desc: "Sixte Mineure (4 tons) : Love Story, romantique." },
                '6M': { val: 9, desc: "Sixte Majeure (4.5 tons) : Doux, pastorale." },
                '7m': { val: 10, desc: "Septi√®me Mineure (5 tons) : Funky, Blues." },
                '7M': { val: 11, desc: "Septi√®me Majeure (5.5 tons) : Planant, nostalgique." },
                '8J': { val: 12, desc: "Octave (6 tons) : La m√™me note plus aigu√´." }
            };
            
            const INTERVALS = {}; 
            Object.keys(INTERVALS_DATA).forEach(k => INTERVALS[k] = INTERVALS_DATA[k].val);
            const intervalKeys = Object.keys(INTERVALS);

            const CHALLENGES = {
                bronze: { name: 'Bronze', goal: 10, lives: 3, next: 'silver', time: 180 },
                silver: { name: 'Argent', goal: 20, lives: 3, next: 'gold', time: 180 },
                gold:   { name: 'Or', goal: 30, lives: 3, next: null, time: 120 }
            };

            const el = (id) => document.getElementById(id);
            // State
            let rootNote, targetNote, correctInterval;
            let gameInProgress = false, soundReady = false, synth;
            let activeIntervalKeys = [...intervalKeys]; 
            let currentNoteDisplay;
            let lives, score, currentChallenge, currentMode;
            let timerInterval, timeLeft;

            // Sound
            const initSound = async () => { if (!soundReady) { try { await Tone.start(); synth = new Tone.FMSynth({ harmonicity: 3.01, modulationIndex: 14, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.4 } }).toDestination(); soundReady = true; } catch (e) { console.error("Could not start audio.", e); } } };
            const getNoteWithOctave = (s, f) => { const total = TUNING_SEMITONES_FROM_C0[s] + f; return NOTES[total % 12] + Math.floor(total / 12); };
            const playInterval = () => { if (soundReady && rootNote && targetNote) { const rootOctave = getNoteWithOctave(rootNote.string, rootNote.fret); const targetOctave = getNoteWithOctave(targetNote.string, targetNote.fret); synth.triggerAttackRelease(rootOctave, "8n"); synth.triggerAttackRelease(targetOctave, "8n", "+4n"); } };

            // Navigation Helpers
            const hideAllScreens = () => {
                ['login-screen', 'main-menu', 'challenge-selection-menu', 'review-setup-screen', 'app-container'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }

            // Navigation Handlers
            document.querySelector('[data-action="open-challenge-menu"]').addEventListener('click', () => { hideAllScreens(); el('challenge-selection-menu').classList.remove('hidden'); });
            el('start-review-setup-btn').addEventListener('click', () => { renderCheckboxes(el('review-checkboxes'), true); hideAllScreens(); el('review-setup-screen').classList.remove('hidden'); });
            document.querySelectorAll('[data-action="back-to-main"]').forEach(b => b.addEventListener('click', () => { 
                hideAllScreens(); 
                el('main-menu').classList.remove('hidden');
                if(window.saveScoreToFirebase) { /* No explicit reload needed, snapshot is live */ }
            }));

            el('back-button').addEventListener('click', () => {
                if (timerInterval) clearInterval(timerInterval);
                hideAllScreens();
                if(currentMode === 'challenge') el('challenge-selection-menu').classList.remove('hidden');
                else if(currentMode === 'review') el('review-setup-screen').classList.remove('hidden');
                else el('main-menu').classList.remove('hidden');
            });

            // Game Logic
            const startChallenge = (challengeKey) => {
                currentMode = 'challenge';
                currentChallenge = { ...CHALLENGES[challengeKey], key: challengeKey };
                activeIntervalKeys = [...intervalKeys]; 
                lives = currentChallenge.lives;
                score = 0;
                
                el('app-title').textContent = `Challenge ${currentChallenge.name}`;
                el('game-ui-bar').classList.remove('hidden');
                el('training-section-controls').classList.remove('hidden');
                el('review-lesson-box').classList.add('hidden');
                
                updateScoreDisplay();
                updateLivesDisplay();
                startTimer(currentChallenge.time);
                hideAllScreens();
                el('app-container').classList.remove('hidden');
                gameInProgress = true;
                newQuestion();
            };

            const startReviewSession = () => {
                const checked = el('review-checkboxes').querySelectorAll('input:checked');
                if (checked.length === 0) { alert("S√©lectionnez au moins un intervalle !"); return; }
                activeIntervalKeys = Array.from(checked).map(cb => cb.value);
                currentMode = 'review';
                el('app-title').textContent = 'Entra√Ænement Libre';
                el('game-ui-bar').classList.add('hidden');
                el('training-section-controls').classList.remove('hidden');
                el('review-lesson-box').classList.remove('hidden');
                el('lesson-content').innerHTML = activeIntervalKeys.map(k => `<div class="mb-1 flex gap-2"><strong class="text-indigo-300 bg-indigo-900 px-1 rounded text-xs flex items-center">${k}</strong> <span class="text-gray-300">${INTERVALS_DATA[k].desc}</span></div>`).join('');
                hideAllScreens();
                el('app-container').classList.remove('hidden');
                gameInProgress = true;
                newQuestion();
            };

            const startTimer = (seconds) => {
                if (timerInterval) clearInterval(timerInterval);
                if (!seconds) { el('timer-display').classList.add('hidden'); return; }
                timeLeft = seconds;
                el('timer-display').classList.remove('hidden');
                el('timer-display').textContent = `${timeLeft}s`;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    el('timer-display').textContent = `${timeLeft}s`;
                    if (timeLeft <= 0) endGame(false, 'timeout');
                }, 1000);
            };

            const endGame = (isWin, reason = null) => {
                if (timerInterval) clearInterval(timerInterval);
                gameInProgress = false;
                el('end-game-buttons').innerHTML = '';
                
                if(currentMode === 'challenge') {
                    if(window.saveScoreToFirebase) window.saveScoreToFirebase(score, currentChallenge.name);
                }

                if (isWin) {
                    el('end-game-title').textContent = `Challenge Valid√© !`;
                    el('end-game-title').className = 'text-4xl font-bold mb-4 text-green-400 tracking-tighter';
                    el('end-game-message').innerHTML = `<div class="bg-green-900/30 border border-green-500/30 p-6 rounded-xl text-green-100"><p class="text-xl font-bold mb-2">F√©licitations ! üéâ</p><p class="text-sm opacity-80">Score enregistr√©.</p></div>`;
                    if (currentChallenge.next) {
                        el('end-game-buttons').appendChild(createButton(`Niveau Suivant`, 'bg-blue-600', () => { el('end-game-modal').classList.add('hidden'); startChallenge(currentChallenge.next); }));
                    }
                } else {
                    el('end-game-title').textContent = 'A√Øe...';
                    el('end-game-title').className = 'text-4xl font-bold mb-4 text-red-400';
                    el('end-game-message').innerHTML = `<div class="mb-4">${reason === 'timeout' ? "Temps √©coul√©." : "Plus de vies."}</div><div class="text-sm text-gray-500">Score enregistr√© : ${score}/${currentChallenge.goal}</div>`;
                    el('end-game-buttons').appendChild(createButton('R√©essayer', 'bg-gray-600', () => { el('end-game-modal').classList.add('hidden'); startChallenge(currentChallenge.key); }));
                }
                el('end-game-buttons').appendChild(createButton('Menu Principal', 'bg-transparent border border-gray-600 hover:bg-gray-700', () => { 
                    el('end-game-modal').classList.add('hidden'); 
                    hideAllScreens();
                    el('main-menu').classList.remove('hidden');
                }));
                el('end-game-modal').classList.remove('hidden');
            };

            // Core Game Functions
            const getNoteValue = (s, f) => (TUNING_SEMITONES_FROM_C0[s] + f) % 12;
            const findValidTarget = (root) => {
                const possibleTargets = [];
                const minFret = Math.max(0, root.fret - SEARCH_ZONE_RADIUS);
                const maxFret = Math.min(NUM_FRETS, root.fret + SEARCH_ZONE_RADIUS);
                const stringsToCheck = [];
                for (let i = -STRING_SEARCH_RADIUS; i <= STRING_SEARCH_RADIUS; i++) {
                    const stringIndex = root.string + i;
                    if (stringIndex >= 0 && stringIndex < NUM_STRINGS) stringsToCheck.push(stringIndex);
                }
                for (const s of stringsToCheck) {
                    for (let f = minFret; f <= maxFret; f++) {
                        if (s === root.string && f === root.fret) continue;
                        let intervalValue = (getNoteValue(s, f) - getNoteValue(root.string, root.fret) + 12) % 12;
                        if (intervalValue === 0) intervalValue = 12; 
                        if (activeIntervalKeys.some(key => INTERVALS[key] === intervalValue)) possibleTargets.push({ string: s, fret: f });
                    }
                }
                return possibleTargets.length > 0 ? possibleTargets[Math.floor(Math.random() * possibleTargets.length)] : null;
            };

            const newQuestion = () => {
                if (!gameInProgress) return;
                clearBoard();
                el('feedback-message').textContent = '';
                el('new-question-btn').classList.add('btn-disabled');
                el('new-question-btn').classList.remove('btn-highlight');
                currentNoteDisplay = Math.random() < 0.5 ? NOTES_SHARP : NOTES_FLAT;
                let potentialRootNote, potentialTargetNote, retries = 0;
                while (!potentialTargetNote && retries < 200) {
                    const randomString = Math.floor(Math.random() * NUM_STRINGS);
                    const randomFret = Math.floor(Math.random() * (NUM_FRETS - 5)) + 3;
                    potentialRootNote = { string: randomString, fret: randomFret };
                    potentialTargetNote = findValidTarget(potentialRootNote);
                    retries++;
                }
                if (!potentialTargetNote) { alert("Pas de question possible."); return; }
                rootNote = potentialRootNote; targetNote = potentialTargetNote;
                const rVal = getNoteValue(rootNote.string, rootNote.fret);
                const tVal = getNoteValue(targetNote.string, targetNote.fret);
                let iVal = (tVal - rVal + 12) % 12; if (iVal === 0) iVal = 12;
                correctInterval = Object.keys(INTERVALS).find(key => INTERVALS[key] === iVal);
                placeNote(rootNote.string, rootNote.fret, 'F', { note: currentNoteDisplay[rVal] });
                placeNote(targetNote.string, targetNote.fret, 'T');
                generateAnswerChoices();
                playInterval();
            };

            const generateAnswerChoices = () => {
                const pool = activeIntervalKeys.filter(key => key !== correctInterval);
                const distractors = pool.sort(() => 0.5 - Math.random()).slice(0, 3);
                const choices = [correctInterval, ...distractors].sort(() => 0.5 - Math.random());
                el('answer-buttons').innerHTML = '';
                choices.forEach(choice => {
                    const btn = createButton(choice, 'answer-btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-4 px-4 rounded-lg transition-all text-xl shadow-md', () => handleAnswerClick(choice));
                    btn.dataset.interval = choice;
                    el('answer-buttons').appendChild(btn);
                });
            };

            const handleAnswerClick = (selectedInterval) => {
                if (!gameInProgress) return;
                const isCorrect = selectedInterval === correctInterval;
                el('answer-buttons').querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.style.borderBottomWidth = '0px'; btn.style.transform = 'translateY(2px)';
                    if (btn.dataset.interval === correctInterval) btn.classList.add('correct');
                    else if (btn.dataset.interval === selectedInterval && !isCorrect) btn.classList.add('incorrect');
                    else btn.classList.add('opacity-30');
                });
                if (isCorrect) {
                    el('feedback-message').innerHTML = `<span class="text-green-400">Correct !</span>`;
                    if (currentMode === 'challenge') { score++; updateScoreDisplay(); if (score >= currentChallenge.goal) setTimeout(() => endGame(true), 1000); }
                } else {
                    el('feedback-message').innerHTML = `<span class="text-red-400">Rat√©, c'√©tait ${correctInterval}</span>`;
                    if (currentMode === 'challenge') { lives--; updateLivesDisplay(); if (lives <= 0) setTimeout(() => endGame(false), 1000); }
                }
                if ((currentMode === 'review') || (currentMode === 'challenge' && lives > 0 && score < currentChallenge.goal)) {
                    el('new-question-btn').classList.remove('btn-disabled');
                    el('new-question-btn').classList.add('btn-highlight');
                }
            };

            const updateScoreDisplay = () => { if(el('score-display') && currentChallenge) el('score-display').textContent = `${score}/${currentChallenge.goal}`; };
            const updateLivesDisplay = () => { if(!el('lives-display') || !currentChallenge) return; el('lives-display').innerHTML = ''; for (let i = 0; i < currentChallenge.lives; i++) { el('lives-display').innerHTML += (i < lives) ? '‚ù§Ô∏è' : '<span class="opacity-20 grayscale">‚ù§Ô∏è</span>'; } };

            // UI Generation
            function createButton(text, classes, onClick) { const btn = document.createElement('button'); btn.textContent = text; btn.className = `${classes} text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200`; btn.onclick = onClick; return btn; }
            function placeNote(s, f, type, data = {}) {
                const fretWrapper = el('guitar-neck').querySelector(`[data-string='${s}'][data-fret='${f}']`).parentElement;
                removeNote(s,f);
                const noteDot = document.createElement('div');
                let bgColor = (type === 'F') ? 'bg-sky-500' : ((type === 'T') ? 'bg-indigo-500' : 'bg-red-500');
                noteDot.className = `note-dot w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm z-30 ${bgColor} text-white absolute`;
                noteDot.textContent = (type === 'F') ? data.note : ((type === 'T') ? '?' : 'X');
                fretWrapper.appendChild(noteDot);
            }
            function removeNote(s, f) { const w = el('guitar-neck').querySelector(`[data-string='${s}'][data-fret='${f}']`)?.parentElement; if (w) w.querySelector('.note-dot')?.remove(); }
            function clearBoard() { el('guitar-neck').querySelectorAll('.note-dot').forEach(n => n.remove()); }
            
            function drawFretboard() {
                const neckContainer = document.createElement('div'); neckContainer.className = 'fretboard relative flex flex-col-reverse p-1 rounded-lg shadow-inner';
                for (let i = 0; i < NUM_STRINGS; i++) {
                    const stringEl = document.createElement('div'); stringEl.className = 'string-container relative flex items-center h-12'; stringEl.dataset.stringId = i;
                    const stringLine = document.createElement('div'); stringLine.className = 'string absolute left-0 right-0 z-10';
                    stringLine.style.height = `${((NUM_STRINGS - 1 - i) * 0.6) + 1}px`;
                    stringEl.appendChild(stringLine);
                    for (let j = 0; j < NUM_FRETS + 1; j++) {
                        const fretContainer = document.createElement('div'); fretContainer.className = 'fret-wrapper relative flex-1 h-full flex justify-center items-center border-r border-transparent';
                        if (j === 0) { const nut = document.createElement('div'); nut.className = 'fret-nut absolute right-0 top-0 bottom-0'; nut.style.width = '8px'; fretContainer.appendChild(nut); } 
                        else { const fretLine = document.createElement('div'); fretLine.className = 'fret-line absolute right-0 top-0 bottom-0'; fretLine.style.width = '2px'; fretContainer.appendChild(fretLine); }
                        const clickableArea = document.createElement('div'); clickableArea.className = 'note-target absolute inset-0 z-20 cursor-pointer'; clickableArea.dataset.string = i; clickableArea.dataset.fret = j;
                        fretContainer.appendChild(clickableArea); stringEl.appendChild(fretContainer);
                    }
                    neckContainer.appendChild(stringEl);
                }
                el('guitar-neck').innerHTML = ''; el('guitar-neck').appendChild(neckContainer);
                
                // Markers
                const middleString = neckContainer.children[2];
                [3,5,7,9,15].forEach(fret => { const cell = middleString.children[fret+1]; if(cell) { const mark = document.createElement('div'); mark.className = 'absolute w-4 h-4 rounded-full bg-black/30 z-0'; cell.insertBefore(mark, cell.firstChild); } });
                const sG = neckContainer.children[3]; const sD = neckContainer.children[2];
                const cG12 = sG.children[13]; const cD12 = sD.children[13];
                if(cG12 && cD12) { 
                    const m1 = document.createElement('div'); m1.className = 'absolute w-4 h-4 rounded-full bg-black/30 translate-y-2 z-0';
                    const m2 = document.createElement('div'); m2.className = 'absolute w-4 h-4 rounded-full bg-black/30 -translate-y-2 z-0';
                    cG12.insertBefore(m1, cG12.firstChild); cD12.insertBefore(m2, cD12.firstChild);
                }
            }

            function renderCheckboxes(container, isReviewSetup = false) {
                container.innerHTML = '';
                intervalKeys.forEach(key => {
                    const wrapper = document.createElement('div'); wrapper.className = 'flex items-center bg-gray-700/50 p-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition-colors';
                    const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `check-${isReviewSetup ? 'review' : 'settings'}-${key}`; checkbox.value = key; checkbox.checked = true; checkbox.className = 'h-5 w-5 rounded border-gray-500 text-sky-500 focus:ring-sky-500 bg-gray-800 cursor-pointer';
                    const label = document.createElement('label'); label.htmlFor = checkbox.id; label.innerHTML = `<span class="font-bold text-sky-300 text-lg block">${key}</span> <span class="text-xs text-gray-400 leading-tight block">${INTERVALS_DATA[key].desc.split(':')[0]}</span>`; label.className = 'ml-3 cursor-pointer select-none flex-1';
                    wrapper.append(checkbox, label); container.appendChild(wrapper);
                });
            }

            // Listeners
            drawFretboard();
            document.querySelectorAll('.challenge-btn').forEach(btn => btn.addEventListener('click', (e) => startChallenge(e.currentTarget.dataset.challenge)));
            el('launch-review-btn').addEventListener('click', startReviewSession);
            el('review-select-all').addEventListener('click', () => el('review-checkboxes').querySelectorAll('input').forEach(cb => cb.checked = true));
            el('review-deselect-all').addEventListener('click', () => el('review-checkboxes').querySelectorAll('input').forEach(cb => cb.checked = false));
            el('new-question-btn').addEventListener('click', () => { if(!el('new-question-btn').classList.contains('btn-disabled')) { gameInProgress = true; newQuestion(); } });
            el('replay-sound-btn').addEventListener('click', playInterval);
            el('btn-brain-info').addEventListener('click', () => el('brain-modal').classList.remove('hidden'));
            el('close-brain-btn').addEventListener('click', () => el('brain-modal').classList.add('hidden'));
        });
    </script>
</body>
</html>
